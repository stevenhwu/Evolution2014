#!/bin/bash
today=`date +%d`

## for testing only
today=`date -d 20140622 +%d`
#echo $today
#echo ${MapDateToCode[21]}
#echo ${MapDateToCode[22]}
## end testing

dateCode="${MapDateToCode[${today}]}"
oldDateCode=`expr $dateCode - 1`
#oldDateCode=`echo "$dateCode-1" | bc`

echo -e "Preprocess files at local Server\n";

#### post process into ROOM folder
for r in "${!MapRoomToIP[@]}";
  do
    if [ ! -d "${LocalServer}/${r}" ]
    then
      mkdir -p ${LocalServer}/$r;
    fi

  #echo -e "=====Run ${dateCode}*_${r}=====${oldDateCode}=====\n\n"
  removeOld=`ls ${LocalServer}/${r}/ | grep -E "${oldDateCode}._"`
 
  for old in ${removeOld}; do 
    rm -r ${LocalServer}/${r}/${old}/;
  done

#  rsync -arzivvv --progress  --include "*${dateCode}*_${r}*" --exclude "*" --delete-excluded ${LocalServerCache}/ ${LocalServer}/${r};
#  rsync -arzivvv --progress  --include "${dateCode}*_${r}" --exclude "${oldDateCode}*" --delete-excluded ${LocalServerCache}/ ${LocalServer}/${r}/;
  rsync -arz --delete ${LocalServerCache}/${dateCode}?_${r} ${LocalServer}/${r};
done


